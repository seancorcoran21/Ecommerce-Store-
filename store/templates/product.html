{% extends 'base.html' %}

{% block content %}



<div class="container">
    <div class="card mb-3">
  <div class="row g-0">
    <div class="col-md-4">
      <img src="{{ product.image.url }}" class="img-fluid rounded-start" alt="...">
    </div>
    <div class="col-md-8">
      <div class="card-body">
        
        <h5 class="card-title">{{ product.name }}</h5>

        <p>
            Average Rating:
            {% with avg=product.average_rating %}
                {% for i in "12345" %}
                    {% if forloop.counter <= avg %}
                        ⭐
                    {% elif avg|floatformat:1 > forloop.counter0 and avg|floatformat:1 < forloop.counter %}
                        ⭐½
                    {% else %}
                        ☆
                    {% endif %}
                {% endfor %}
                ({{ avg|floatformat:1 }} / 5)
            {% endwith %}
        </p>

        <!-- Clickable Star Rating Form -->
        {% if user.is_authenticated %}
        <form method="post" class="mt-2">
            {% csrf_token %}
            <div class="rating-input" aria-label="Rate this product">
                <input type="radio" name="score" id="star5" value="5">
                <label for="star5" title="5 stars">★</label>

                <input type="radio" name="score" id="star4" value="4">
                <label for="star4" title="4 stars">★</label>

                <input type="radio" name="score" id="star3" value="3">
                <label for="star3" title="3 stars">★</label>

                <input type="radio" name="score" id="star2" value="2">
                <label for="star2" title="2 stars">★</label>

                <input type="radio" name="score" id="star1" value="1">
                <label for="star1" title="1 star">★</label>
            </div>

            <textarea name="review" class="form-control mt-2" placeholder="Write a review (optional)"></textarea>

            <button type="submit" class="btn btn-primary btn-sm mt-2">Submit Rating</button>
        </form>
        {% else %}
        <p><a href="{% url 'login' %}">Log in</a> to rate this product.</p>
        {% endif %}





        <p class="card-text">{{ product.description }}</p>
        <br></br>
        <center>

        {% if product.is_sale %}
                            <!-- Sale Badge-->
                             <div class="badge bg-danger text-white position-absolute" style="top: 0.5rem; right: 0.5rem;">Sale</div>

                          
                            <!-- Product details-->
                            <div class="card-body p-4">
                                <div class="text-center">
                                    
                                    <!-- Product price-->  
                                    <strike>${{ product.price }}</strike>
                                    &nbsp;
                                    ${{ product.sale_price }}
                                    </center>
                                    
                                    
                                    
 
        {% else %}
            ${{ product.price }}
            
                                    

        {% endif %}
        <br></br>
        
        <center>
<br></br>        <a href="{% url 'home' %}" class="btn btn-secondary" id="add-cart">Home</a>
<button type="button" class="btn btn-secondary add-to-cart" data-product-id="{{ product.id }}">
  Add To Cart
</button>                  
        </center>
        


   
      </div>
    </div>
  </div>
</div>
</div> 
<section>
        <div class="container">
    <div class="card mb-3">
  <div class="row g-0">
        <h4>Customer Reviews:</h4>
        {% if reviews %}
            <ul class="list-group">
                {% for review in reviews %}
                    <li class="list-group-item">
                        <strong>{{ review.user.username }}</strong>
                        {% if review.review %}
                            said:<br>
                            {{ review.review|linebreaks }}
                            <br>
                        {% endif %}
                        <small class="text-muted">{{ review.created_at|date:"M d, Y H:i" }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No reviews yet. Be the first to review this product!</p>
        {% endif %}
   
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', async () => {
      console.log('Add to Cart button clicked!');

      const productId = button.dataset.productId;
      console.log('Product ID:', productId);

      if (!productId) {
        alert("Product ID is missing.");
        return;
      }

      try {
        const response = await fetch('/cart/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: new URLSearchParams({
            'action': 'post',
            'product_id': productId
          })
        });

        const data = await response.json();

        if (response.ok) {
          console.log("Server responded with:", data);

          const cartQtyElement = document.getElementById("cart_quantity");
          console.log("Found cart quantity element:", cartQtyElement);

          if (cartQtyElement) {
            cartQtyElement.textContent = data.qty;
            console.log("Badge text updated to:", data.qty);
          } else {
            console.warn("Cart quantity element not found in DOM!");
          }

          // Optional alert:
          // alert(`${data.qty} item(s) in cart.`);
        } else {
          console.error('Error response:', data);
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        console.error('Fetch error:', error);
        alert('An error occurred while adding to cart.');
      }
    });
  });
});

function getCookie(name) {
  const cookieValue = document.cookie
    .split('; ')
    .find(row => row.startsWith(name + '='))
    ?.split('=')[1];
  return decodeURIComponent(cookieValue || '');
}
</script>



{% endblock %}